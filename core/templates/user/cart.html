{% extends "base.html" %}
{% load static %}

{% block title %}Lista de Envio{% endblock %}

{% block content %}

<h2 class="fw-bold mb-3 text-danger">Lista de Envio</h2>

{% if not items %}
  <div class="alert alert-warning">
    Sua lista está vazia. Volte e adicione produtos.
  </div>
  <a href="{% url 'requisition_list' %}" class="btn btn-danger fw-bold">Voltar</a>
{% else %}

<div class="table-responsive">
  <table class="table table-bordered table-striped shadow-sm bg-white">
    <thead class="table-danger">
      <tr class="fw-bold text-center">
        <th>Requisição</th>
        <th>Produto</th>
        <th style="width:220px;">Quantidade</th>
        <th style="width:140px;">Ações</th>
      </tr>
    </thead>

    <tbody>
      {% for it in items %}
      <tr>
        <td>{{ it.product.requisition.name }}</td>
        <td class="fw-bold">{{ it.product.name }}</td>

        <td>
          <div class="d-flex gap-2 align-items-center justify-content-center">
            <button type="button" class="qty-btn" onclick="stepQty('{{ it.product.id }}', -1)">−</button>

            <input id="qty_{{ it.product.id }}" class="qty-input"
                   type="text" value="{{ it.quantity }}" readonly>

            <button type="button" class="qty-btn" onclick="stepQty('{{ it.product.id }}', 1)">+</button>

            <form action="{% url 'cart_update' it.product.id %}" method="post" class="ms-2">
              {% csrf_token %}
              <input type="hidden" name="quantity" id="hidden_qty_{{ it.product.id }}" value="{{ it.quantity }}">
              <button type="submit" class="btn btn-sm btn-danger fw-bold"
                      onclick="syncHidden('{{ it.product.id }}')">
                Atualizar
              </button>
            </form>
          </div>
        </td>

        <td class="text-center">
          <form action="{% url 'cart_remove' it.product.id %}" method="post">
            {% csrf_token %}
            <button class="btn btn-sm btn-outline-danger fw-bold" type="submit">Excluir</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="d-flex gap-2">
  <a href="{% url 'requisition_list' %}" class="btn btn-outline-danger fw-bold">Adicionar mais itens</a>

  <form action="{% url 'cart_submit' %}" method="post">
    {% csrf_token %}
    <button class="btn btn-danger fw-bold">Enviar Pedido</button>
  </form>
</div>

{% endif %}

<style>
.qty-btn {
  width: 34px;
  height: 34px;
  background: #A61C1C;
  color: #fff;
  border: none;
  border-radius: 6px;
  font-size: 20px;
  font-weight: bold;
}

.qty-input {
  width: 54px;
  height: 34px;
  text-align: center;
  font-weight: bold;
  border: 1px solid #ccc;
  border-radius: 6px;
}
</style>

<script>
function stepQty(id, amount) {
  const input = document.getElementById("qty_" + id);
  let value = parseInt(input.value) || 0;
  value += amount;
  if (value < 0) value = 0;
  input.value = value;
}

function syncHidden(id) {
  const visible = document.getElementById("qty_" + id);
  const hidden = document.getElementById("hidden_qty_" + id);
  hidden.value = parseInt(visible.value) || 0;
}
</script>

{% endblock %}
